#!/bin/bash
#
# enpass_cp
#
# Usage: enpass_cp [-p|--pattern <string>] [-n|--number <int>]
#                  [-f|--file <path>] [--persist <sec>]
#                  [-l|--list] [-v|--verbose]
#                  [-h|--help]
# 
# A program to retrieve backed up Enpass passwords
#

FILENAME=$HOME/Dropbox/backups/enpass_export_latest.csv
NUM=1
PERSIST=60
LIST=0
NOCLIP=0
VERBOSE=0

while [ $# -ge 1 ]; do
    case "$1" in
        -p|--pattern)
            match_pattern="$2"
            shift # past argument
            ;;
        -n|--number)
            NUM="$2"
            shift
            ;;
        -f|--file)
            FILENAME="$2"
            shift # past argument
            ;;
        --persist)
            PERSIST="$2"
            shift # past argument
            ;;
        -l|--list)
            LIST=1
            PERSIST=0.01
            ;;
        --no-clip)
            NOCLIP=1
            ;;
        -v|--verbose)
            VERBOSE=1
            ;;
        -h|--help)
            echo "Usage: enpass_cp [-p|--pattern <string>] [-n|--number <int>]"
            echo "                 [-f|--file <path>] [--persist <sec>]"
            echo "                 [-l|--list] [-v|--verbose]"
            echo "                 [-h|--help]"
            echo ""
            echo "A program to retrieve backed up Enpass passwords"
            exit 1
            ;;
        *)
            # unknown option
            ;;
    esac
    shift # past argument or value
done

LIST_TMPFILE=/tmp/ep_list.log
enpass_list $match_pattern > $LIST_TMPFILE
LIST_OUTPUT=`cat $LIST_TMPFILE`
LIST_IDCS=`awk -F ')' '{print $1}' $LIST_TMPFILE`
if [ $LIST -eq 1 ]; then
    echo $LIST_OUTPUT
fi

FIND_TMPFILE=/tmp/ep_find.log
enpass_find $match_pattern $NUM > $FIND_TMPFILE
FIND_OUTPUT=`cat $FIND_TMPFILE`
PASSWRD=`awk 'END{print $1}' $FIND_TMPFILE`
if [ $NOCLIP -eq 1 ] || [ $VERBOSE -eq 1 ]; then
    echo $PASSWRD
fi

if [ $NOCLIP -eq 0 ]; then
    echo $PASSWRD | xclip -r -selection c
fi

cmd='sleep "$0" && echo "" | xclip -r -selection c'
nohup sh -c "$cmd" "$PERSIST" >/dev/null 2>&1 &

rm -f $LIST_TMPFILE $FIND_TMPFILE

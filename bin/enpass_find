#!/usr/bin/awk -f

BEGIN {
    FS=OFS=","
    IGNORECASE=1
    count=0
    match_pattern=ARGV[1]
    delete ARGV[1]
    target=ARGV[2]
    if (ARGC < 3) {
        target=1
    }
    delete ARGV[2]
    if (ARGC < 4) {
        ARGC=4
        ARGV[3]=ENVIRON["HOME"]"/Dropbox/backups/enpass_export_latest.csv"
    }
}

{
    currF=substr($1,2,length($1)-2)
    
    if (tolower(currF) ~ tolower(match_pattern)) {
        count++
        name=currF
        if (count == target) {
            for (i=1; i<NF; i++) {
                if (tolower($i) ~ tolower("password")) {
                    pwstr=substr($i,2,length($i)-2)
                    pw=substr($(i+1),2,length($(i+1))-2)
                    printf "%s: %s\n%s\n", name, pwstr, pw
                }
            }
            exit
        }
    }
}
